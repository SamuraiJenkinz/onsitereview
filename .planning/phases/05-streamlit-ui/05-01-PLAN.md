# Phase 5: Streamlit UI - Execution Plan

## Overview

Build a web interface for ticket quality review using Streamlit. Users upload JSON files, select evaluation templates, view real-time progress, and explore results through an analytics dashboard.

## Dependencies

- Phase 4 (Scoring Engine): `TicketEvaluator`, `BatchTicketEvaluator`, `BatchProgress`
- Existing: `ServiceNowParser`, `TemplateType`, `EvaluationResult`, `BatchEvaluationSummary`

## Application Structure

```
src/tqrs/ui/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ app.py              # Main Streamlit application
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ upload.py       # File upload component
â”‚   â”œâ”€â”€ progress.py     # Progress tracking component
â”‚   â”œâ”€â”€ results.py      # Results display components
â”‚   â””â”€â”€ analytics.py    # Analytics dashboard
â””â”€â”€ state.py            # Session state management
```

## Tasks

### Task 1: Session State Management

**File**: `src/tqrs/ui/state.py`

Manage application state across Streamlit reruns:

```python
@dataclass
class AppState:
    tickets: list[ServiceNowTicket] | None = None
    template: TemplateType = TemplateType.INCIDENT_LOGGING
    results: list[EvaluationResult] | None = None
    summary: BatchEvaluationSummary | None = None
    is_processing: bool = False
    current_progress: BatchProgress | None = None
    error_message: str | None = None

def init_state() -> None:
    """Initialize session state with defaults."""

def get_state() -> AppState:
    """Get current application state."""

def update_state(**kwargs) -> None:
    """Update state attributes."""

def reset_state() -> None:
    """Reset to initial state."""
```

**Acceptance**: State persists across reruns, reset works correctly.

---

### Task 2: File Upload Component

**File**: `src/tqrs/ui/components/upload.py`

Handle JSON file upload and parsing:

```python
def render_upload_section() -> None:
    """Render file upload interface."""
    # File uploader
    # Template selector (radio buttons)
    # API key input (password field)
    # Process button

def validate_uploaded_file(file) -> tuple[bool, str]:
    """Validate uploaded JSON file."""

def parse_uploaded_file(file) -> list[ServiceNowTicket]:
    """Parse uploaded file to tickets."""
```

Features:
- Drag-and-drop file upload
- Template selection (Incident Logging, Handling, Customer Service)
- API key configuration (secure password input)
- File validation with error messages
- Ticket count display after upload

**Acceptance**: Can upload prototype_samples.json and see ticket count.

---

### Task 3: Progress Tracking Component

**File**: `src/tqrs/ui/components/progress.py`

Real-time progress display during evaluation:

```python
def render_progress_section() -> None:
    """Render progress tracking UI."""
    # Progress bar
    # Current ticket being processed
    # Elapsed time
    # Estimated remaining time
    # Error count

def create_progress_callback() -> Callable[[BatchProgress], None]:
    """Create callback for batch evaluator."""
```

Features:
- Animated progress bar
- Current ticket number/total display
- Time tracking (elapsed, remaining estimate)
- Error counter with expandable details
- Cancel button (if feasible)

**Acceptance**: Progress updates in real-time during batch evaluation.

---

### Task 4: Results Display Component

**File**: `src/tqrs/ui/components/results.py`

Display individual ticket evaluation results:

```python
def render_results_section() -> None:
    """Render results viewing interface."""
    # Ticket selector (dropdown or table)
    # Score summary card
    # Criterion breakdown
    # Strengths/improvements list
    # Coaching recommendations

def render_ticket_card(result: EvaluationResult) -> None:
    """Render single ticket result card."""

def render_criterion_table(result: EvaluationResult) -> None:
    """Render criterion scores as table."""

def render_coaching_section(result: EvaluationResult) -> None:
    """Render coaching recommendations."""
```

Features:
- Ticket list/table with filtering
- Score display with color-coded band
- Pass/fail indicator
- Expandable criterion details
- Evidence quotes from ticket
- Coaching recommendations highlighted

**Acceptance**: Can view detailed results for each ticket.

---

### Task 5: Analytics Dashboard

**File**: `src/tqrs/ui/components/analytics.py`

Batch-level analytics and visualizations:

```python
def render_analytics_section() -> None:
    """Render analytics dashboard."""
    # Summary metrics (cards)
    # Score distribution chart
    # Band distribution pie chart
    # Common issues bar chart
    # Pass/fail rate

def create_score_distribution_chart(results: list[EvaluationResult]) -> go.Figure:
    """Create score distribution histogram."""

def create_band_distribution_chart(summary: BatchEvaluationSummary) -> go.Figure:
    """Create band distribution pie chart."""

def create_common_issues_chart(summary: BatchEvaluationSummary) -> go.Figure:
    """Create common issues bar chart."""
```

Features:
- Summary metrics row (total, passed, failed, avg score)
- Score distribution histogram (Plotly)
- Performance band pie chart
- Common issues horizontal bar chart
- Filter by band/pass status

**Acceptance**: Dashboard shows accurate batch statistics with charts.

---

### Task 6: Main Application

**File**: `src/tqrs/ui/app.py`

Main Streamlit application orchestrating components:

```python
def main() -> None:
    """Main Streamlit application."""
    st.set_page_config(
        page_title="TQRS - Ticket Quality Review",
        page_icon="ðŸ“Š",
        layout="wide",
    )

    init_state()

    # Sidebar: Upload and configuration
    with st.sidebar:
        render_upload_section()

    # Main area: Tabs for different views
    if get_state().results:
        tab1, tab2 = st.tabs(["ðŸ“Š Analytics", "ðŸŽ« Tickets"])
        with tab1:
            render_analytics_section()
        with tab2:
            render_results_section()
    elif get_state().is_processing:
        render_progress_section()
    else:
        render_welcome_message()

def run_evaluation() -> None:
    """Run batch evaluation with progress updates."""
```

Features:
- Wide layout for dashboard
- Sidebar for configuration
- Tabbed main content
- Welcome message when no data
- Error handling with user-friendly messages

**Acceptance**: Full workflow from upload to results viewing.

---

### Task 7: Export Functionality

Add export capabilities:

```python
def render_export_section() -> None:
    """Render export options."""
    # Export as JSON
    # Export as CSV
    # Export individual reports (Phase 6 preview)

def export_results_json(results: list[EvaluationResult]) -> str:
    """Export results as JSON."""

def export_results_csv(results: list[EvaluationResult]) -> str:
    """Export results as CSV."""
```

**Acceptance**: Can download results in JSON and CSV formats.

---

### Task 8: Testing & Polish

- Manual testing with prototype_samples.json
- Error handling for edge cases
- Loading states and spinners
- Responsive layout adjustments
- Help text and tooltips

**Acceptance**: Polished UI with good UX for common workflows.

---

## Validation Criteria

| Criterion | Target |
|-----------|--------|
| Upload and parse JSON | Required |
| Template selection works | Required |
| Progress tracking displays | Required |
| Results viewable per ticket | Required |
| Analytics dashboard functional | Required |
| Export to JSON/CSV | Required |
| Error handling user-friendly | Required |

## Files Created/Modified

### New Files
- `src/tqrs/ui/__init__.py`
- `src/tqrs/ui/app.py`
- `src/tqrs/ui/state.py`
- `src/tqrs/ui/components/__init__.py`
- `src/tqrs/ui/components/upload.py`
- `src/tqrs/ui/components/progress.py`
- `src/tqrs/ui/components/results.py`
- `src/tqrs/ui/components/analytics.py`

### Modified Files
- `pyproject.toml` (add streamlit, plotly dependencies if not present)

## Execution Order

1. Task 1 (State) - Foundation for all components
2. Task 2 (Upload) - Entry point for data
3. Task 3 (Progress) - Feedback during processing
4. Task 6 (Main App) - Wire up basic flow
5. Task 4 (Results) - Display individual tickets
6. Task 5 (Analytics) - Batch-level insights
7. Task 7 (Export) - Data export capability
8. Task 8 (Polish) - Final refinements

## Notes

- Use Streamlit's native components where possible
- Plotly for interactive charts (already in dependencies)
- Session state for data persistence
- Progress callback integration with BatchTicketEvaluator
- Mock LLM for UI testing (avoid API costs during development)
